# cuda11.1-cudnn8:
#   image: docker:19.03.12
#   services:
#     - docker:19.03.12-dind
#   stage: docker-build
#   tags:
#     - gitlab-org-docker
#   variables: 
#     CONTAINER_VERSION: "cuda11.1-cudnn8"
#   before_script:
#     - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
#   script:
#     - docker build -f "$CONTAINER_VERSION/Dockerfile" --pull -t "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION" .
#     - docker push "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION"
#   only:
#     changes:
#     - cuda11.1-cudnn8/*
#     - .gitlab/docker-build/cuda11.1-cudnn8.yaml

cuda11.1-cudnn8:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  stage: docker-build
  tags:
    - gitlab-org-docker
  variables: 
    CONTAINER_VERSION: "cuda11.1-cudnn8"
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --cache=true --snapshotMode=redo --context $CI_PROJECT_DIR --dockerfile $CONTAINER_VERSION/Dockerfile --destination $CI_REGISTRY_IMAGE:$CONTAINER_VERSION
  only:
    changes:
    - cuda11.1-cudnn8/*
    - .gitlab/docker-build/cuda11.1-cudnn8.yaml
    