.show_version_before: &show_version_before
  - echo CONTAINER_VERSION $CONTAINER_VERSION
  - echo ANACONDA_VERSION $ANACONDA
  - echo OPENCV_VERSION $OPENCV
  - echo TF_GPU_VERSION $TF_GPU
  - echo KERAS_VERSION $KERAS
  - echo TORCH_VERSION $TORCH
  - echo TORCH_VISION_VERSION $TORCH_VISION
  - echo TORCH_SUMMARY_VERSION $TORCH_SUMMARY
  - echo CUPY_CUDA_VERSION $CUPY_CUDA
  - echo CUDA_VERSION_FOR_CUPY $CUDA_VERSION_FOR_CUPY
  - echo JUPYTER_VERSION $JUPYTER
  - echo NODEJS_VERSION $NODEJS
  - echo CODE_SERVER_VERSION $CODE_SERVER
  - echo TORCH_FILE $TORCH_FILE
  - echo TORCH_VISION_FILE $TORCH_VISION_FILE
  - echo TF_TYPE $TF_TYPE  
  - echo CUDA_VERSION_FOR_CUPY $CUDA_MAJOR$CUDA_MINOR
  - echo CONTAINER_IMAGE_NAME $CONTAINER_IMAGE_NAME

.all_before: &all_before
  - CUDA_MAJOR=`echo $CONTAINER_VERSION | sed 's/cuda//g' | cut -d. -f1`
  - CUDA_MINOR=`echo $CONTAINER_VERSION | cut -d. -f2 | cut -d- -f1`
  - CUDA_VERSION_FOR_CUPY=$CUDA_MAJOR$CUDA_MINOR
  - >
    if [ -n `echo $CONTAINER_VERSION | grep -E *-test` ];then \
      CONTAINER_IMAGE_NAME="$CI_REGISTRY_IMAGE/test";
    else  
      CONTAINER_IMAGE_NAME="$CI_REGISTRY_IMAGE";
    fi
  
.kaniko_executor: &kaniko_executor
  - mkdir -p /kaniko/.docker
  - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
  - >
    /kaniko/executor \
      --snapshotMode redo \
      --context $CI_PROJECT_DIR \
      --dockerfile Dockerfile \
      --destination $CONTAINER_IMAGE_NAME:$CONTAINER_VERSION \
      --build-arg ANACONDA_VERSION=$ANACONDA \
      --build-arg OPENCV_VERSION=$OPENCV \
      --build-arg TF_GPU_VERSION=$TF_GPU \
      --build-arg KERAS_VERSION=$KERAS \
      --build-arg TORCH_VERSION=$TORCH \
      --build-arg TORCH_VISION_VERSION=$TORCH_VISION \
      --build-arg TORCH_SUMMARY_VERSION=$TORCH_SUMMARY \
      --build-arg CUPY_CUDA_VERSION=$CUPY_CUDA \
      --build-arg CUDA_VERSION_FOR_CUPY=$CUDA_VERSION_FOR_CUPY \
      --build-arg JUPYTER_VERSION=$JUPYTER \
      --build-arg NODEJS_VERSION=$NODEJS \
      --build-arg CODE_SERVER_VERSION=$CODE_SERVER \
      --build-arg TORCH_FILE=$TORCH_FILE \
      --build-arg TORCH_VISION_FILE=$TORCH_VISION_FILE \
      --build-arg TF_TYPE=$TF_TYPE \

.unittest_script: &unittest_script
  - >
    docker run -u 1000 --rm \
      -v $PWD/tests:/home/user/tests \
      -v $PWD/Makefile:/home/user/Makefile \
      -e ANACONDA_VERSION=$ANACONDA \
      -e OPENCV_VERSION=$OPENCV \
      -e TF_GPU_VERSION=$TF_GPU \
      -e KERAS_VERSION=$KERAS \
      -e TORCH_VERSION=$TORCH \
      -e TORCH_VISION_VERSION=$TORCH_VISION \
      -e TORCH_SUMMARY_VERSION=$TORCH_SUMMARY \
      -e CUPY_CUDA_VERSION=$CUPY_CUDA \
      -e CUDA_VERSION_FOR_CUPY=$CUDA_VERSION_FOR_CUPY \
      -e JUPYTER_VERSION=$JUPYTER \
      -e NODEJS_VERSION=$NODEJS \
      -e CODE_SERVER_VERSION=$CODE_SERVER \
      -e TORCH_FILE=$TORCH_FILE \
      -e TORCH_VISION_FILE=$TORCH_VISION_FILE \
      -e TF_TYPE=$TF_TYPE \
      $CONTAINER_IMAGE_NAME:$CONTAINER_VERSION \
      make unittest

.ci-image-build-patterns: &ci-image-build-patterns
  - .gitlab/docker-build/template.yaml
  - .gitlab/docker-build/versions.yaml
  - .gitlab/docker-build/$CONTAINER_VERSION.yaml
  - Dockerfile

.if-merge-request: &if-merge-request
  if: '$CI_PIPELINE_SOURCE == "merge_request_event"'  

.if-commit-master: &if-commit-master
  if: '$CI_COMMIT_REF_NAME == "master"'

.if-scheduled-job: &if-scheduled-job
  if: '$CI_PIPELINE_SOURCE == "schedule"'

.merge-request-rules:
  rules:
    - <<: *if-merge-request
      changes: *ci-image-build-patterns

.commit-master-rules:  
  rules:
    - <<: *if-commit-master
      changes: *ci-image-build-patterns
    - <<: *if-scheduled-job
      when: always

.test-image-builder:
  stage: docker-build
  extends: .merge-request-rules
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  tags:
    - gitlab-org-docker
  before_script:
    - *all_before
    - *show_version_before
  script:
    - *kaniko_executor
  retry:
    max: 2

.unittest-test:
  stage: unittest
  extends: .merge-request-rules
  tags:
    - gitlab-org-docker  
  image: docker:stable
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - *all_before    
    - *show_version_before    
  script:
    - *unittest_script
  artifacts:
    reports:
      cobertura: 'tests/coverage.xml' 

.container-image-builder:
  stage: docker-build
  extends: .commit-master-rules
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  tags:
    - gitlab-org-docker
  before_script:
    - *all_before
    - *show_version_before      
  script:
    - *kaniko_executor
  retry:
    max: 2

.unittest:
  stage: unittest
  extends: .commit-master-rules
  tags:
    - gitlab-org-docker  
  image: docker:stable
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - *all_before    
    - *show_version_before    
  script:
    - *unittest_script
  artifacts:
    reports:
      cobertura: 'tests/coverage.xml' 
    