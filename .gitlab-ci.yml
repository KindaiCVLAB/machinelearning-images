stages:
  - prepare-dind
  - docker-build

docker19.03.12:
  image: docker:19.03.12
  services:
    - docker:19.03.12-dind
  stage: build-dind
  tags:
    - gitlab-org-docker
  variables: 
    CONTAINER_VERSION: "docker19.03.12"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build -f "$CONTAINER_VERSION/Dockerfile" --pull -t "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION" .
    - docker push "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION"
  only:
    changes:
    - docker19.03.12/*
    - .gitlab-ci.yml

docker19.03.12-dind:
  image: docker:19.03.12
  services:
    - docker:19.03.12-dind
  stage: build-dind
  tags:
    - gitlab-org-docker
  variables: 
    CONTAINER_VERSION: "docker19.03.12-dind"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build -f "$CONTAINER_VERSION/Dockerfile" --pull -t "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION" .
    - docker push "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION"
  only:
    changes:
    - docker19.03.12-dind/*
    - .gitlab-ci.yml

cuda10.0:
  image: registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12
  services:
    - registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12-dind
  stage: docker-build
  tags:
    - gitlab-org-docker
  variables: 
    CONTAINER_VERSION: "cuda10.0"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build -f "$CONTAINER_VERSION/Dockerfile" --pull -t "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION" .
    - docker push "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION"
  only:
    changes:
    - cuda10.0/*
    - .gitlab-ci.yml
    
cuda10.0-docker:
  image: registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12
  services:
    - registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12-dind
  stage: docker-build
  tags:
    - gitlab-org-docker
  variables: 
    CONTAINER_VERSION: "cuda10.0"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build -f "$CONTAINER_VERSION/Dockerfile" --pull -t "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION" .
    - docker push "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION"
  only:
    changes:
    - cuda10.0-docker/*
    - .gitlab-ci.yml

cuda10.0-fukushima:
  image: registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12
  services:
    - registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12-dind
  stage: docker-build
  tags:
    - gitlab-org-docker
  variables: 
    CONTAINER_VERSION: "cuda10.0-fukushima"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build -f "$CONTAINER_VERSION/Dockerfile" --pull -t "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION" .
    - docker push "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION"
  only:
    changes:
    - cuda10.0-fukushima/*
    - .gitlab-ci.yml

cuda10.2-cudnn7:
  image: registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12
  services:
    - registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12-dind
  stage: docker-build
  tags:
    - gitlab-org-docker
  variables: 
    CONTAINER_VERSION: "cuda10.2-cudnn7"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build -f "$CONTAINER_VERSION/Dockerfile" --pull -t "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION" .
    - docker push "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION"
  only:
    changes:
    - cuda10.2-cudnn7/*
    - .gitlab-ci.yml

cuda10.2-cudnn7-docker:
  image: registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12
  services:
    - registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12-dind
  stage: docker-build
  tags:
    - gitlab-org-docker
  variables: 
    CONTAINER_VERSION: "cuda10.2-cudnn7-docker"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build -f "$CONTAINER_VERSION/Dockerfile" --pull -t "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION" .
    - docker push "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION"
  only:
    changes:
    - cuda10.2-cudnn7-docker/*
    - .gitlab-ci.yml

cuda10.2-cudnn8:
  image: registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12
  services:
    - registry.gitlab.com/kindaicvlab/deeplearning:docker:19.03.12-dind
  stage: docker-build
  tags:
    - gitlab-org-docker
  variables: 
    CONTAINER_VERSION: "cuda10.2-cudnn8"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build -f "$CONTAINER_VERSION/Dockerfile" --pull -t "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION" .
    - docker push "$CI_REGISTRY_IMAGE:$CONTAINER_VERSION"
  only:
    changes:
    - cuda10.2-cudnn8/*
    - .gitlab-ci.yml
